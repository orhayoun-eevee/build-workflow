name: Release Helm Chart

on:
  workflow_call:
    inputs:
      chart_path:
        description: 'Path to the helm chart directory'
        required: false
        type: string
        default: '.'
      release_environment:
        description: 'GitHub environment for publish approvals/policies'
        required: false
        type: string
        default: 'production'
      enable_signing:
        description: 'Enable keyless signing/attestation for OCI chart artifacts'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: release-chart-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Publish Helm Chart to GitHub OCI
    runs-on: ubuntu-latest
    environment: ${{ inputs.release_environment }}
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      YQ_VERSION: v4.52.4
      YQ_SHA256: 0c4d965ea944b64b8fddaf7f27779ee3034e5693263786506ccd1c120f184e8c
      COSIGN_VERSION: v2.4.1
      COSIGN_SHA256: 5dcfb458dbb3f6bc5ea4f8ef2317be1f0ed5f4f0f13f55813f76f0e4d6669fba
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: 'v3.20.0'

      - name: Install yq
        run: |
          set -euo pipefail
          curl -fsSL -o yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          echo "${YQ_SHA256}  yq" | sha256sum -c -
          chmod +x yq
          sudo mv yq /usr/local/bin/yq
          yq --version

      - name: Install cosign
        if: inputs.enable_signing
        run: |
          set -euo pipefail
          curl -fsSL -o cosign "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
          echo "${COSIGN_SHA256}  cosign" | sha256sum -c -
          chmod +x cosign
          sudo mv cosign /usr/local/bin/cosign
          cosign version

      - name: Set chart path
        id: chart_path
        run: |
          set -euo pipefail
          CHART_PATH="${{ inputs.chart_path }}"
          if [ -z "${CHART_PATH}" ] || [ "${CHART_PATH}" = "null" ]; then
            CHART_PATH="."
          fi
          echo "path=${CHART_PATH}" >> "${GITHUB_OUTPUT}"
          echo "Using chart path: ${CHART_PATH}"

      - name: Verify Chart.yaml version matches git tag
        working-directory: ${{ steps.chart_path.outputs.path }}
        run: |
          set -euo pipefail

          GIT_TAG="${GITHUB_REF#refs/tags/}"
          if [[ "${GIT_TAG}" =~ ^v[0-9] ]]; then
            TAG_VERSION="${GIT_TAG#v}"
          else
            TAG_VERSION="${GIT_TAG}"
          fi

          if [ -z "${TAG_VERSION}" ]; then
            echo "ERROR: Could not extract version from git tag: ${GIT_TAG}"
            echo "Tag should be in format 'v1.2.3' or '1.2.3'"
            exit 1
          fi

          CHART_VERSION=$(yq eval '.version' Chart.yaml)

          echo "Git tag: ${GIT_TAG}"
          echo "Extracted tag version: ${TAG_VERSION}"
          echo "Chart.yaml version: ${CHART_VERSION}"

          if [ "${TAG_VERSION}" != "${CHART_VERSION}" ]; then
            echo "ERROR: Chart.yaml version (${CHART_VERSION}) does not match git tag version (${TAG_VERSION})"
            exit 1
          fi

          echo "Version verification passed: ${CHART_VERSION}"

      - name: Build Helm dependencies
        working-directory: ${{ steps.chart_path.outputs.path }}
        run: |
          set -euo pipefail
          helm dependency build

      - name: Package Helm chart
        working-directory: ${{ steps.chart_path.outputs.path }}
        run: |
          set -euo pipefail
          helm package .

      - name: Login to GitHub Container Registry
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            --username "${{ github.repository_owner }}" \
            --password-stdin

      - name: Push chart to GitHub OCI
        id: publish
        working-directory: ${{ steps.chart_path.outputs.path }}
        run: |
          set -euo pipefail
          CHART_NAME=$(yq eval '.name' Chart.yaml)
          CHART_VERSION=$(yq eval '.version' Chart.yaml)
          PACKAGE_FILE="${CHART_NAME}-${CHART_VERSION}.tgz"

          if [ ! -f "${PACKAGE_FILE}" ]; then
            echo "ERROR: Package file not found: ${PACKAGE_FILE}"
            exit 1
          fi

          OCI_REF="ghcr.io/${{ github.repository_owner }}/${CHART_NAME}:${CHART_VERSION}"
          echo "Pushing ${PACKAGE_FILE} to oci://ghcr.io/${{ github.repository_owner }}"
          helm push "${PACKAGE_FILE}" "oci://ghcr.io/${{ github.repository_owner }}"

          {
            echo "chart_name=${CHART_NAME}"
            echo "chart_version=${CHART_VERSION}"
            echo "oci_ref=${OCI_REF}"
          } >> "${GITHUB_OUTPUT}"

          echo "Successfully published: ${OCI_REF}"

      - name: Sign OCI chart artifact (keyless)
        if: inputs.enable_signing
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          set -euo pipefail
          cosign sign --yes "${{ steps.publish.outputs.oci_ref }}"

      - name: Attest OCI chart artifact (keyless)
        if: inputs.enable_signing
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          set -euo pipefail
          cat > provenance.json <<JSON
          {
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "sha": "${{ github.sha }}",
            "chart": "${{ steps.publish.outputs.chart_name }}",
            "version": "${{ steps.publish.outputs.chart_version }}"
          }
          JSON

          cosign attest \
            --yes \
            --predicate provenance.json \
            --type slsaprovenance \
            "${{ steps.publish.outputs.oci_ref }}"

      - name: Summarize release
        run: |
          {
            echo "## Chart Release"
            echo ""
            echo "- OCI ref: \
\`${{ steps.publish.outputs.oci_ref }}\`"
            echo "- Signing enabled: \
\`${{ inputs.enable_signing }}\`"
          } >> "${GITHUB_STEP_SUMMARY}"
