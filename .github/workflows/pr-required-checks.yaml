name: PR Required Checks

on:
  pull_request:
    branches:
      - main
  merge_group:
    types:
      - checks_requested

permissions:
  contents: read

concurrency:
  group: pr-required-checks-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RENOVATE_IMAGE: ghcr.io/renovatebot/renovate@sha256:02283d42a0fc5a887fd0987cf7e460ff5fd1f655829f8db2aa15ea12cc223d4e

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      run_guardrails: ${{ steps.filter.outputs.run_guardrails }}
      run_docker_smoke: ${{ steps.filter.outputs.run_docker_smoke }}
      run_renovate_validation: ${{ steps.filter.outputs.run_renovate_validation }}
      run_codeql: ${{ steps.filter.outputs.run_codeql }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        shell: bash
        env:
          MODE: build
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || '' }}
          HEAD_SHA: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        run: |
          set -euo pipefail
          ./scripts/detect-required-checks.sh

  quality-guardrails:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_guardrails == 'true'
    permissions:
      contents: read
    uses: ./.github/workflows/quality-guardrails.yaml

  docker-build-smoke:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.run_docker_smoke == 'true'
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build helm-validate image (smoke test)
        run: docker build -t helm-validate:pr-smoke ./docker

  renovate-config-validation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.run_renovate_validation == 'true'
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate renovate config
        run: |
          docker run --rm -v "$PWD:/repo" -w /repo "${RENOVATE_IMAGE}" renovate-config-validator
          docker run --rm -v "$PWD:/repo" -w /repo "${RENOVATE_IMAGE}" renovate-config-validator --strict

  codeql:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_codeql == 'true'
    permissions:
      actions: read
      contents: read
      security-events: write
    uses: ./.github/workflows/codeql.yaml

  required-checks:
    name: required-checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    needs:
      - detect-changes
      - quality-guardrails
      - docker-build-smoke
      - renovate-config-validation
      - codeql
    if: always()
    steps:
      - name: Validate required job results
        shell: bash
        run: |
          set -euo pipefail

          declare -A job_results=(
            ["quality-guardrails"]="${{ needs.quality-guardrails.result }}"
            ["docker-build-smoke"]="${{ needs.docker-build-smoke.result }}"
            ["renovate-config-validation"]="${{ needs.renovate-config-validation.result }}"
            ["codeql"]="${{ needs.codeql.result }}"
          )

          failed=0
          for job in "${!job_results[@]}"; do
            result="${job_results[$job]}"
            echo "${job}: ${result}"
            if [[ "${result}" == "failure" || "${result}" == "cancelled" ]]; then
              failed=1
            fi
          done

          if [[ "${failed}" -ne 0 ]]; then
            echo "One or more required PR checks failed."
            exit 1
          fi

          echo "All required PR checks passed."
