name: PR Validation Flow v2

on:
  workflow_call:
    inputs:
      chart_path:
        description: 'Path to Helm chart directory'
        required: false
        type: string
        default: '.'
      
      # Control which checks run
      run_lint:
        description: 'Run helm lint'
        required: false
        type: boolean
        default: true
      
      run_ct_lint:
        description: 'Run chart-testing lint'
        required: false
        type: boolean
        default: true
      
      run_tests:
        description: 'Run helm-unittest'
        required: false
        type: boolean
        default: true
      
      run_golden:
        description: 'Run golden file comparison'
        required: false
        type: boolean
        default: true
      
      run_kubeconform:
        description: 'Run kubeconform validation'
        required: false
        type: boolean
        default: true
      
      run_checkov:
        description: 'Run Checkov security checks'
        required: false
        type: boolean
        default: true
      
      run_version_check:
        description: 'Check Chart.yaml version was bumped'
        required: false
        type: boolean
        default: true
      
      # Paths and config
      golden_file:
        description: 'Path to golden file (auto-detected if not specified)'
        required: false
        type: string
        default: ''
      
      values_file:
        description: 'Values file for templating (auto-detected if not specified)'
        required: false
        type: string
        default: ''
      
      lint_additional_charts:
        description: 'Comma-separated additional charts to lint (optional)'
        required: false
        type: string
        default: ''
      
      # Other config
      checkov_skip_checks:
        description: 'Checkov checks to skip for golden file scan (comma-separated). Only skip truly impractical checks.'
        required: false
        type: string
        default: 'CKV_K8S_43'  # CKV_K8S_43: Image digest (not practical for Helm charts)

# Security: Restrict permissions to minimum needed
permissions:
  contents: read

# Centralized tool versions
env:
  HELM_VERSION: 'v4.1.0'
  KUBECONFORM_VERSION: 'v0.7.0'
  CT_VERSION: 'v3.12.0'
  HELM_UNITTEST_VERSION: 'v1.0.3'
  # Note: yq 4.50.1 is pre-installed on ubuntu-latest

# Concurrency control to avoid redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        shell: bash
    steps:
      # Checkout code with full history for version checking
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      # Validate inputs early to fail fast with clear errors
      - name: Validate inputs
        env:
          CHART_PATH: ${{ inputs.chart_path }}
        run: |
          if [ ! -d "$CHART_PATH" ]; then
            echo "‚ùå ERROR: chart_path '$CHART_PATH' is not a directory"
            exit 1
          fi
          if [ ! -f "$CHART_PATH/Chart.yaml" ]; then
            echo "‚ùå ERROR: No Chart.yaml found in '$CHART_PATH'"
            exit 1
          fi
          echo "‚úì Input validation passed"

      # Set up Helm with latest stable version
      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: ${{ env.HELM_VERSION }}

      # Install kubeconform for manifest validation
      - name: Install kubeconform
        run: |
          EXPECTED_SHA="c31518ddd122663b3f3aa874cfe8178cb0988de944f29c74a0b9260920d115d3"
          
          curl -L -o kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          
          ACTUAL_SHA=$(sha256sum kubeconform.tar.gz | cut -d' ' -f1)
          if [ "${ACTUAL_SHA}" != "${EXPECTED_SHA}" ]; then
            echo "‚ùå ERROR: Checksum mismatch! Expected ${EXPECTED_SHA}, got ${ACTUAL_SHA}"
            exit 1
          fi
          
          tar -xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      # Install helm-unittest plugin
      - name: Install helm-unittest plugin
        if: ${{ inputs.run_tests }}
        run: |
          # Note: helm-unittest releases are not signed, so --verify=false is required
          helm plugin install https://github.com/helm-unittest/helm-unittest.git --version ${HELM_UNITTEST_VERSION} --verify=false

      # Install chart-testing (ct)
      - name: Install chart-testing (ct)
        if: ${{ inputs.run_ct_lint }}
        run: |
          EXPECTED_SHA="8b450caac147de6838bde818f6923324c60585295181198eeb624b22c02894f4"
          
          curl -L -o chart-testing.tar.gz "https://github.com/helm/chart-testing/releases/download/${CT_VERSION}/chart-testing_${CT_VERSION#v}_linux_amd64.tar.gz"
          
          ACTUAL_SHA=$(sha256sum chart-testing.tar.gz | cut -d' ' -f1)
          if [ "${ACTUAL_SHA}" != "${EXPECTED_SHA}" ]; then
            echo "‚ùå ERROR: Checksum mismatch! Expected ${EXPECTED_SHA}, got ${ACTUAL_SHA}"
            exit 1
          fi
          
          tar -xzf chart-testing.tar.gz
          sudo mv ct /usr/local/bin/
          ct version

      # Fetch chart-testing config
      - name: Fetch chart-testing config
        if: ${{ inputs.run_ct_lint }}
        run: |
          mkdir -p .ct
          curl -sSL -o .ct/chart_schema.yaml \
            https://raw.githubusercontent.com/helm/chart-testing/main/etc/chart_schema.yaml
          curl -sSL -o .ct/lintconf.yaml \
            https://raw.githubusercontent.com/helm/chart-testing/main/etc/lintconf.yaml

      # Update Helm dependencies
      - name: Update Helm dependencies
        env:
          CHART_PATH: ${{ inputs.chart_path }}
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm dependency build

      # Version bump check
      - name: Check chart version consistency
        id: version_check
        if: ${{ inputs.run_version_check }}
        continue-on-error: true
        env:
          CHART_PATH: ${{ inputs.chart_path }}
        run: |
          ./scripts/version-check.sh "$CHART_PATH"

      # Lint chart
      - name: Lint Helm chart
        id: lint
        if: ${{ inputs.run_lint }}
        continue-on-error: true
        env:
          CHART_PATH: ${{ inputs.chart_path }}
          RUN_CT_LINT: ${{ inputs.run_ct_lint }}
          ADDITIONAL_CHARTS: ${{ inputs.lint_additional_charts }}
        run: |
          LINT_ARGS="--strict"
          if [ "$RUN_CT_LINT" = "true" ]; then
            LINT_ARGS="$LINT_ARGS --ct"
          fi
          if [ -n "$ADDITIONAL_CHARTS" ]; then
            LINT_ARGS="$LINT_ARGS --additional $ADDITIONAL_CHARTS"
          fi
          ./scripts/lint.sh $LINT_ARGS "$CHART_PATH"

      # Run unit tests
      - name: Run helm unittest
        id: test
        if: ${{ inputs.run_tests }}
        continue-on-error: true
        env:
          CHART_PATH: ${{ inputs.chart_path }}
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm unittest .

      # Validate with kubeconform
      - name: Validate with kubeconform
        id: kubeconform
        if: ${{ inputs.run_kubeconform }}
        continue-on-error: true
        env:
          CHART_PATH: ${{ inputs.chart_path }}
          VALUES_FILE: ${{ inputs.values_file }}
        run: |
          KUBECONFORM_ARGS=""
          if [ -n "$VALUES_FILE" ]; then
            KUBECONFORM_ARGS="$KUBECONFORM_ARGS --values-file $VALUES_FILE"
          fi
          ./scripts/kubeconform.sh $KUBECONFORM_ARGS "$CHART_PATH"

      # Validate golden file
      - name: Validate golden file
        id: golden
        if: ${{ inputs.run_golden }}
        continue-on-error: true
        env:
          CHART_PATH: ${{ inputs.chart_path }}
          GOLDEN_FILE: ${{ inputs.golden_file }}
          VALUES_FILE: ${{ inputs.values_file }}
        run: |
          GOLDEN_ARGS=""
          if [ -n "$GOLDEN_FILE" ]; then
            GOLDEN_ARGS="$GOLDEN_ARGS --golden-file $GOLDEN_FILE"
          fi
          if [ -n "$VALUES_FILE" ]; then
            GOLDEN_ARGS="$GOLDEN_ARGS --values-file $VALUES_FILE"
          fi
          ./scripts/golden.sh $GOLDEN_ARGS "$CHART_PATH"

      # Policy checks on golden file with Checkov
      - name: Policy checks on golden file with Checkov
        id: checkov
        if: ${{ inputs.run_golden && inputs.run_checkov }}
        continue-on-error: true
        uses: bridgecrewio/checkov-action@f34885219720066007f948b843e747bb136aa223 # v3.2.500
        with:
          file: ${{ inputs.golden_file || 'tests/golden.yaml' }}
          framework: kubernetes
          soft_fail: false
          output_format: cli
          quiet: false
          skip_check: ${{ inputs.checkov_skip_checks }}

      # Ensure golden file is up to date (let golden.sh handle path detection)
      - name: Ensure golden file is up to date
        id: golden_git_check
        if: ${{ inputs.run_golden }}
        continue-on-error: true
        env:
          GOLDEN_FILE: ${{ inputs.golden_file }}
        run: |
          # Use golden.sh's auto-detection if GOLDEN_FILE is empty
          if [ -z "$GOLDEN_FILE" ]; then
            if [ -f "tests/golden.yaml" ]; then
              GOLDEN_FILE="tests/golden.yaml"
            elif [ -f "gold/gold_file.yaml" ]; then
              GOLDEN_FILE="gold/gold_file.yaml"
            else
              echo "‚ö†Ô∏è  WARNING: Could not detect golden file path"
              exit 0
            fi
          fi
          
          if ! git diff --exit-code "$GOLDEN_FILE" > /dev/null 2>&1; then
            echo ""
            echo "‚ùå ERROR: Golden file has uncommitted changes!"
            echo ""
            echo "The golden snapshot ($GOLDEN_FILE) differs from what's committed."
            echo "This means the templates have changed but the golden file wasn't updated."
            echo ""
            echo "To fix this:"
            echo "  1. Run locally: make golden-update"
            echo "  2. Review the diff: git diff $GOLDEN_FILE"
            echo "  3. If changes are expected: git add $GOLDEN_FILE && git commit"
            echo "  4. Push the updated golden file"
            echo ""
            exit 1
          fi
          echo "‚úì Golden file is up to date"

      # Generate validation summary
      - name: Validation Summary
        if: always()
        run: |
          echo "## üìä Helm Chart Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Version check
          if [ "${{ inputs.run_version_check }}" = "true" ]; then
            if [ "${{ steps.version_check.outcome }}" = "success" ]; then
              echo "| Version Check | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.version_check.outcome }}" = "failure" ]; then
              echo "| Version Check | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Version Check | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Lint
          if [ "${{ inputs.run_lint }}" = "true" ]; then
            if [ "${{ steps.lint.outcome }}" = "success" ]; then
              echo "| Helm Lint | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.lint.outcome }}" = "failure" ]; then
              echo "| Helm Lint | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Helm Lint | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Tests
          if [ "${{ inputs.run_tests }}" = "true" ]; then
            if [ "${{ steps.test.outcome }}" = "success" ]; then
              echo "| Unit Tests | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.test.outcome }}" = "failure" ]; then
              echo "| Unit Tests | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Unit Tests | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Kubeconform
          if [ "${{ inputs.run_kubeconform }}" = "true" ]; then
            if [ "${{ steps.kubeconform.outcome }}" = "success" ]; then
              echo "| Kubeconform | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.kubeconform.outcome }}" = "failure" ]; then
              echo "| Kubeconform | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Kubeconform | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Golden
          if [ "${{ inputs.run_golden }}" = "true" ]; then
            if [ "${{ steps.golden.outcome }}" = "success" ]; then
              echo "| Golden File | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.golden.outcome }}" = "failure" ]; then
              echo "| Golden File | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Golden File | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Golden git check
            if [ "${{ steps.golden_git_check.outcome }}" = "success" ]; then
              echo "| Golden Up-to-Date | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.golden_git_check.outcome }}" = "failure" ]; then
              echo "| Golden Up-to-Date | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Golden Up-to-Date | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Checkov
          if [ "${{ inputs.run_golden }}" = "true" ] && [ "${{ inputs.run_checkov }}" = "true" ]; then
            if [ "${{ steps.checkov.outcome }}" = "success" ]; then
              echo "| Checkov Security | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.checkov.outcome }}" = "failure" ]; then
              echo "| Checkov Security | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Checkov Security | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Path:** \`${{ inputs.chart_path }}\`" >> $GITHUB_STEP_SUMMARY

      # Final gate: fail if any check failed
      - name: Check validation results
        if: always()
        run: |
          FAILED=false
          
          if [ "${{ steps.version_check.outcome }}" = "failure" ]; then
            echo "‚ùå Version check failed"
            FAILED=true
          fi
          
          if [ "${{ steps.lint.outcome }}" = "failure" ]; then
            echo "‚ùå Lint failed"
            FAILED=true
          fi
          
          if [ "${{ steps.test.outcome }}" = "failure" ]; then
            echo "‚ùå Unit tests failed"
            FAILED=true
          fi
          
          if [ "${{ steps.kubeconform.outcome }}" = "failure" ]; then
            echo "‚ùå Kubeconform validation failed"
            FAILED=true
          fi
          
          if [ "${{ steps.golden.outcome }}" = "failure" ]; then
            echo "‚ùå Golden file validation failed"
            FAILED=true
          fi
          
          if [ "${{ steps.golden_git_check.outcome }}" = "failure" ]; then
            echo "‚ùå Golden file not up to date"
            FAILED=true
          fi
          
          if [ "${{ steps.checkov.outcome }}" = "failure" ]; then
            echo "‚ùå Checkov security checks failed"
            FAILED=true
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo ""
            echo "‚ùå One or more validation checks failed. See summary above."
            exit 1
          fi
          
          echo "‚úÖ All validation checks passed!"
