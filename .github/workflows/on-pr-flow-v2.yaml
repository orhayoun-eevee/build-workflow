name: PR Validation Flow v2

on:
  workflow_call:
    inputs:
      chart_path:
        description: 'Path to Helm chart directory'
        required: false
        type: string
        default: '.'
      
      # Control which checks run
      run_lint:
        description: 'Run helm lint'
        required: false
        type: boolean
        default: true
      
      run_ct_lint:
        description: 'Run chart-testing lint'
        required: false
        type: boolean
        default: true
      
      run_tests:
        description: 'Run helm-unittest'
        required: false
        type: boolean
        default: true
      
      run_golden:
        description: 'Run golden file comparison'
        required: false
        type: boolean
        default: true
      
      run_kubeconform:
        description: 'Run kubeconform validation'
        required: false
        type: boolean
        default: true
      
      run_checkov:
        description: 'Run Checkov security checks'
        required: false
        type: boolean
        default: true
      
      run_version_check:
        description: 'Check Chart.yaml version was bumped'
        required: false
        type: boolean
        default: true
      
      # Paths and config
      golden_file:
        description: 'Path to golden file (auto-detected if not specified)'
        required: false
        type: string
        default: ''
      
      values_file:
        description: 'Values file for templating (auto-detected if not specified)'
        required: false
        type: string
        default: ''
      
      lint_additional_charts:
        description: 'Comma-separated additional charts to lint (optional)'
        required: false
        type: string
        default: ''
      
      # Other config
      checkov_skip_checks:
        description: 'Checkov checks to skip (comma-separated)'
        required: false
        type: string
        default: 'CKV_K8S_40'

# Security: Restrict permissions to minimum needed
permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      # Checkout code with full history for version checking
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      # Set up Helm with latest stable version
      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: 'v4.1.0'

      # Install yq for YAML parsing
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      # Install kubeconform for manifest validation
      - name: Install kubeconform
        run: |
          KUBECONFORM_VERSION="v0.7.0"
          EXPECTED_SHA="9fb388349276c53dda48ab46aba73d0c0db2c2a8e2ebe35f7a0b99d4b5e9c0c5"
          
          curl -L -o kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          
          ACTUAL_SHA=$(sha256sum kubeconform.tar.gz | cut -d' ' -f1)
          if [ "${ACTUAL_SHA}" != "${EXPECTED_SHA}" ]; then
            echo "❌ ERROR: Checksum mismatch! Expected ${EXPECTED_SHA}, got ${ACTUAL_SHA}"
            exit 1
          fi
          
          tar -xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      # Install helm-unittest plugin
      - name: Install helm-unittest plugin
        if: ${{ inputs.run_tests }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git --version v1.0.3

      # Install chart-testing (ct)
      - name: Install chart-testing (ct)
        if: ${{ inputs.run_ct_lint }}
        run: |
          curl -LO https://github.com/helm/chart-testing/releases/download/v3.12.0/chart-testing_3.12.0_linux_amd64.tar.gz
          tar -xzf chart-testing_3.12.0_linux_amd64.tar.gz
          sudo mv ct /usr/local/bin/
          ct version

      # Fetch chart-testing config
      - name: Fetch chart-testing config
        if: ${{ inputs.run_ct_lint }}
        run: |
          mkdir -p .ct
          curl -sSL -o .ct/chart_schema.yaml \
            https://raw.githubusercontent.com/helm/chart-testing/main/etc/chart_schema.yaml
          curl -sSL -o .ct/lintconf.yaml \
            https://raw.githubusercontent.com/helm/chart-testing/main/etc/lintconf.yaml

      # Update Helm dependencies
      - name: Update Helm dependencies
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm dependency build

      # Version bump check
      - name: Check chart version consistency
        if: ${{ inputs.run_version_check }}
        run: |
          ./scripts/version-check.sh ${{ inputs.chart_path }}

      # Lint chart
      - name: Lint Helm chart
        if: ${{ inputs.run_lint }}
        run: |
          LINT_CMD="./scripts/lint.sh --strict"
          ${{ inputs.run_ct_lint && '--ct' || '' }}
          ${{ inputs.lint_additional_charts && format('--additional {0}', inputs.lint_additional_charts) || '' }}
          $LINT_CMD ${{ inputs.chart_path }}

      # Run unit tests
      - name: Run helm unittest
        if: ${{ inputs.run_tests }}
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm unittest .

      # Validate with kubeconform
      - name: Validate with kubeconform
        if: ${{ inputs.run_kubeconform }}
        run: |
          KUBECONFORM_CMD="./scripts/kubeconform.sh"
          ${{ inputs.values_file && format('--values-file {0}', inputs.values_file) || '' }}
          $KUBECONFORM_CMD ${{ inputs.chart_path }}

      # Policy checks with Checkov (chart directory)
      - name: Policy checks with Checkov
        if: ${{ inputs.run_checkov }}
        uses: bridgecrewio/checkov-action@f34885219720066007f948b843e747bb136aa223 # v3.2.500
        with:
          directory: ${{ inputs.chart_path }}
          framework: helm
          download_external_modules: true
          soft_fail: false
          output_format: cli
          quiet: false
          skip_check: ${{ inputs.checkov_skip_checks }}

      # Validate golden file
      - name: Validate golden file
        if: ${{ inputs.run_golden }}
        run: |
          GOLDEN_CMD="./scripts/golden.sh"
          ${{ inputs.golden_file && format('--golden-file {0}', inputs.golden_file) || '' }}
          ${{ inputs.values_file && format('--values-file {0}', inputs.values_file) || '' }}
          $GOLDEN_CMD ${{ inputs.chart_path }}

      # Policy checks on golden file with Checkov
      - name: Policy checks on golden file with Checkov
        if: ${{ inputs.run_golden && inputs.run_checkov }}
        uses: bridgecrewio/checkov-action@f34885219720066007f948b843e747bb136aa223 # v3.2.500
        with:
          file: ${{ inputs.golden_file || 'tests/golden.yaml' }}
          framework: kubernetes
          soft_fail: false
          output_format: cli
          quiet: false
          skip_check: ${{ inputs.checkov_skip_checks }}

      # Ensure golden file is up to date
      - name: Ensure golden file is up to date
        if: ${{ inputs.run_golden }}
        run: |
          GOLDEN_FILE="${{ inputs.golden_file }}"
          if [ -z "$GOLDEN_FILE" ]; then
            if [ -f "tests/golden.yaml" ]; then
              GOLDEN_FILE="tests/golden.yaml"
            elif [ -f "gold/gold_file.yaml" ]; then
              GOLDEN_FILE="gold/gold_file.yaml"
            fi
          fi
          
          if ! git diff --exit-code "$GOLDEN_FILE" > /dev/null 2>&1; then
            echo ""
            echo "❌ ERROR: Golden file has uncommitted changes!"
            echo ""
            echo "The golden snapshot ($GOLDEN_FILE) differs from what's committed."
            echo "This means the templates have changed but the golden file wasn't updated."
            echo ""
            echo "To fix this:"
            echo "  1. Run locally: make golden-update"
            echo "  2. Review the diff: git diff $GOLDEN_FILE"
            echo "  3. If changes are expected: git add $GOLDEN_FILE && git commit"
            echo "  4. Push the updated golden file"
            echo ""
            exit 1
          fi
          echo "✓ Golden file is up to date"
