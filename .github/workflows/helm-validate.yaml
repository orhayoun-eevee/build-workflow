name: Helm Chart Validation

on:
  workflow_call:
    inputs:
      chart_path:
        description: 'Path to the Helm chart directory'
        required: true
        type: string
      kubernetes_version:
        description: 'Target Kubernetes version (e.g., 1.30.0)'
        required: true
        type: string
      scenarios_dir:
        description: 'Path to scenario fixtures (repo-relative)'
        required: false
        type: string
        default: 'tests/scenarios'
      snapshots_dir:
        description: 'Path to snapshot files (repo-relative)'
        required: false
        type: string
        default: 'tests/snapshots'
      run_syntax:
        description: 'Run Layer 1 (syntax + helm lint)'
        required: false
        type: boolean
        default: true
      run_schema:
        description: 'Run Layer 2 (kubeconform over rendered scenarios)'
        required: false
        type: boolean
        default: true
      run_metadata:
        description: 'Run Layer 3 (ct lint + version checks)'
        required: false
        type: boolean
        default: true
      run_tests:
        description: 'Run Layer 4 (unit tests + snapshots + fail-cases)'
        required: false
        type: boolean
        default: true
      run_policy:
        description: 'Run Layer 5 (Checkov + kube-linter)'
        required: false
        type: boolean
        default: true
      target_branch:
        description: 'Base branch for version comparison'
        required: false
        type: string
        default: 'main'
      run_version_check:
        description: 'Run version strictly-greater check'
        required: false
        type: boolean
        default: true
      checkov_extra_args:
        description: 'Extra args for Checkov (e.g., --skip-check CKV_K8S_43)'
        required: false
        type: string
        default: ''
      post_pr_comment:
        description: 'Post a summary comment on pull requests'
        required: false
        type: boolean
        default: false
    secrets:
      gh_app_id:
        description: 'GitHub App ID for minting installation token'
        required: true
      gh_app_private_key:
        description: 'GitHub App private key for minting installation token'
        required: true

permissions:
  contents: read

concurrency:
  group: helm-validate-${{ github.workflow }}-${{ github.ref }}-${{ inputs.chart_path }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    container:
      image: ghcr.io/orhayoun-eevee/helm-validate:v0.1.11
    outputs:
      unit_test_files: ${{ steps.quality-metrics.outputs.unit_test_files }}
      unit_test_assertions: ${{ steps.quality-metrics.outputs.unit_test_assertions }}
      scenario_count: ${{ steps.quality-metrics.outputs.scenario_count }}
      fail_case_count: ${{ steps.quality-metrics.outputs.fail_case_count }}
      checkov_skip_count: ${{ steps.quality-metrics.outputs.checkov_skip_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Needed for version comparison and ct lint

      - name: Mint app token for cross-repo checkout
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.gh_app_id }}
          private-key: ${{ secrets.gh_app_private_key }}
          owner: ${{ github.repository_owner }}

      - name: Checkout build-workflow (validation framework)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: orhayoun-eevee/build-workflow
          path: .build-workflow
          ref: v0.1.11
          token: ${{ steps.app-token.outputs.token }}

      - name: Restore Helm caches
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cache/helm
            ~/.config/helm
            ~/.local/share/helm/plugins
            ${{ inputs.chart_path }}/charts
          key: helm-validate-${{ runner.os }}-${{ inputs.chart_path }}-${{ hashFiles(format('{0}/Chart.lock', inputs.chart_path), format('{0}/Chart.yaml', inputs.chart_path)) }}
          restore-keys: |
            helm-validate-${{ runner.os }}-${{ inputs.chart_path }}-
            helm-validate-${{ runner.os }}-

      - name: Resolve chart dependencies
        run: helm dependency build "${{ inputs.chart_path }}"

      - name: Prepare artifact names
        id: artifact-names
        shell: bash
        run: |
          set -euo pipefail
          chart_path="${{ inputs.chart_path }}"
          safe_chart_path="$(echo "${chart_path}" | sed 's|/|-|g' | sed 's|^\.$|root|')"
          {
            echo "logs_artifact_name=validation-logs-${safe_chart_path}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
            echo "metrics_artifact_name=validation-metrics-${safe_chart_path}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          } >> "${GITHUB_OUTPUT}"

      - name: Ensure helm-unittest plugin
        run: |
          if ! helm plugin list 2>/dev/null | awk 'NR>1 {print $1}' | grep -qx unittest; then
            helm plugin install https://github.com/helm-unittest/helm-unittest --version v0.8.2
          fi
          helm plugin list

      - name: Run validation pipeline
        id: run-validation
        continue-on-error: true
        shell: bash
        env:
          CHART_PATH: ${{ inputs.chart_path }}
          KUBERNETES_VERSION: ${{ inputs.kubernetes_version }}
          SCENARIOS_DIR: ${{ inputs.scenarios_dir }}
          SNAPSHOTS_DIR: ${{ inputs.snapshots_dir }}
          RUN_SYNTAX: ${{ inputs.run_syntax }}
          RUN_SCHEMA: ${{ inputs.run_schema }}
          RUN_METADATA: ${{ inputs.run_metadata }}
          RUN_TESTS: ${{ inputs.run_tests }}
          RUN_POLICY: ${{ inputs.run_policy }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          RUN_VERSION_CHECK: ${{ inputs.run_version_check }}
          CHECKOV_EXTRA_ARGS: ${{ inputs.checkov_extra_args }}
          CONFIGS_DIR: .build-workflow/configs
        run: |
          set -o pipefail
          .build-workflow/scripts/validate-orchestrator.sh 2>&1 | tee validation-orchestrator.log

      - name: Compute quality metrics
        id: quality-metrics
        shell: bash
        run: |
          set -euo pipefail

          CHART_PATH="${{ inputs.chart_path }}"
          SCENARIOS_DIR="${{ inputs.scenarios_dir }}"

          unit_test_files=0
          unit_test_assertions=0
          scenario_count=0
          fail_case_count=0
          checkov_skip_count=0

          if [[ -d "${CHART_PATH}/tests" ]]; then
            unit_test_files=$(find "${CHART_PATH}/tests" -type f -name "*_test.yaml" | wc -l | tr -d ' ')
            unit_test_assertions=$(grep -R -h --include='*_test.yaml' -E '^[[:space:]]*- it:' "${CHART_PATH}/tests" | wc -l | tr -d ' ' || true)
          fi

          if [[ -d "${SCENARIOS_DIR}" ]]; then
            scenario_count=$(find "${SCENARIOS_DIR}" -maxdepth 1 -type f -name "*.yaml" | wc -l | tr -d ' ')
          fi

          if [[ -d "${CHART_PATH}/tests/schema-fail-cases" ]]; then
            fail_case_count=$(find "${CHART_PATH}/tests/schema-fail-cases" -maxdepth 1 -type f -name "*.yaml" | wc -l | tr -d ' ')
          fi

          if [[ -f "${CHART_PATH}/.checkov.yaml" ]]; then
            checkov_skip_count=$(grep -c -E '^[[:space:]]*-[[:space:]]*CKV_' "${CHART_PATH}/.checkov.yaml" || true)
          elif [[ -f ".checkov.yaml" ]]; then
            checkov_skip_count=$(grep -c -E '^[[:space:]]*-[[:space:]]*CKV_' ".checkov.yaml" || true)
          fi

          {
            echo "unit_test_files=${unit_test_files}"
            echo "unit_test_assertions=${unit_test_assertions}"
            echo "scenario_count=${scenario_count}"
            echo "fail_case_count=${fail_case_count}"
            echo "checkov_skip_count=${checkov_skip_count}"
          } >> "${GITHUB_OUTPUT}"

          {
            echo "## Validation Quality Metrics"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Unit test files | ${unit_test_files} |"
            echo "| Unit test assertions | ${unit_test_assertions} |"
            echo "| Scenarios | ${scenario_count} |"
            echo "| Schema fail-cases | ${fail_case_count} |"
            echo "| Checkov skip rules | ${checkov_skip_count} |"
          } >> "${GITHUB_STEP_SUMMARY}"

          cat > quality-metrics.json <<JSON
          {
            "chart_path": "${CHART_PATH}",
            "unit_test_files": ${unit_test_files},
            "unit_test_assertions": ${unit_test_assertions},
            "scenario_count": ${scenario_count},
            "fail_case_count": ${fail_case_count},
            "checkov_skip_count": ${checkov_skip_count}
          }
          JSON

      - name: Detect failed validation layer
        id: failed-layer
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          failed_layer="none"
          if [[ "${{ steps.run-validation.outcome }}" == "failure" && -f validation-orchestrator.log ]]; then
            failed_layer="$(grep -Eo 'Stopped at Layer [0-9]+' validation-orchestrator.log | tail -1 | sed 's/Stopped at //')"
            if [[ -z "${failed_layer}" ]]; then
              failed_layer="unknown"
            fi
          fi
          echo "failed_layer=${failed_layer}" >> "${GITHUB_OUTPUT}"

      - name: Upload validation metrics artifact
        if: always() && hashFiles('quality-metrics.json') != ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ steps.artifact-names.outputs.metrics_artifact_name }}
          path: quality-metrics.json
          retention-days: 14

      - name: Upload validation run logs
        if: always() && hashFiles('validation-orchestrator.log') != ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ steps.artifact-names.outputs.logs_artifact_name }}
          path: validation-orchestrator.log
          retention-days: 14

      - name: Summarize validation result
        if: always()
        shell: bash
        run: |
          {
            echo "## Validation Run"
            echo ""
            echo "- Chart path: \`${{ inputs.chart_path }}\`"
            echo "- Pipeline result: \`${{ steps.run-validation.outcome }}\`"
            echo "- Failed layer: \`${{ steps.failed-layer.outputs.failed_layer }}\`"
            echo "- Logs artifact: \`${{ steps.artifact-names.outputs.logs_artifact_name }}\`"
            echo "- Metrics artifact: \`${{ steps.artifact-names.outputs.metrics_artifact_name }}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Fail job when validation pipeline failed
        if: steps.run-validation.outcome == 'failure'
        run: exit 1
