name: PR Checks

on:
  workflow_call:
    inputs:
      working_directory:
        description: 'Directory containing the generate_gold.sh script'
        required: false
        type: string
        default: 'gold'
      script_name:
        description: 'Name of the script to run'
        required: false
        type: string
        default: 'generate_gold.sh'
      chart_path:
        description: 'Path to the helm chart to lint'
        required: false
        type: string
        default: '.'

# ðŸ”’ SECURITY: Restrict permissions to minimum needed
permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      # ðŸ”’ SECURITY: Pin action to commit SHA for immutability
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      # ðŸ“¦ REPRODUCIBILITY: Pin specific Helm version
      - name: Set up Helm
        uses: azure/setup-helm@5119fcb9089d432beecbf79bb2c7915207344b78 # v3.5
        with:
          version: 'v3.13.2' # Pin to specific version, not 'latest'

      # ðŸ”’ SECURITY: Verify checksum when downloading binaries
      - name: Install kubeconform
        run: |
          KUBECONFORM_VERSION="0.6.3"
          # SHA256 checksum for kubeconform v0.6.3 linux-amd64 (verified from release)
          EXPECTED_SHA="478604fe85c711aafe8ef78c0bf25cb93fa46de5a3c07040f25a595096c43f8a"
          
          curl -L -o kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          
          # Verify checksum to prevent supply chain attacks
          ACTUAL_SHA=$(sha256sum kubeconform.tar.gz | cut -d' ' -f1)
          if [ "${ACTUAL_SHA}" != "${EXPECTED_SHA}" ]; then
            echo "âŒ ERROR: Checksum mismatch! Expected ${EXPECTED_SHA}, got ${ACTUAL_SHA}"
            exit 1
          fi
          
          tar -xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      # ðŸ“¦ REPRODUCIBILITY: Pin plugin version
      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git --version 0.4.1

      - name: Check chart version consistency
        working-directory: ${{ inputs.chart_path }}
        run: |
          set -e
          
          # Get current chart version
          CURRENT_VERSION=$(yq eval '.version' Chart.yaml)
          echo "Current chart version: ${CURRENT_VERSION}"
          
          # Determine base ref for comparison
          # Try github.base_ref (available in pull_request events)
          # Fallback to github.event.pull_request.base.ref (for workflow_call from PR)
          # Final fallback to main
          if [ -n "${{ github.base_ref }}" ]; then
            BASE_REF="${{ github.base_ref }}"
          elif [ -n "${{ github.event.pull_request.base.ref }}" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
          else
            BASE_REF="main"
          fi
          
          echo "Comparing against base ref: ${BASE_REF}"
          
          # Fetch base branch to ensure we can compare
          git fetch origin ${BASE_REF} || echo "Warning: Could not fetch ${BASE_REF}, version check may be limited"
          
          # Check if templates or values files changed
          TEMPLATES_CHANGED=$(git diff --name-only origin/${BASE_REF}...HEAD -- templates/ values*.yaml Chart.yaml 2>/dev/null | grep -E "(templates/|values.*\.yaml)" || true)
          CHART_YAML_CHANGED=$(git diff --name-only origin/${BASE_REF}...HEAD -- Chart.yaml 2>/dev/null || true)
          
          if [ -n "$TEMPLATES_CHANGED" ] && [ -z "$CHART_YAML_CHANGED" ]; then
            echo "âŒ ERROR: Templates or values files changed but Chart.yaml version was not bumped"
            echo "Changed files:"
            echo "$TEMPLATES_CHANGED"
            echo ""
            echo "Please bump the version in Chart.yaml before merging."
            exit 1
          fi
          
          if [ -n "$CHART_YAML_CHANGED" ]; then
            # Check if version actually changed
            BASE_VERSION=$(git show origin/${BASE_REF}:${{ inputs.chart_path }}/Chart.yaml 2>/dev/null | yq eval '.version' - || echo "")
            if [ -z "$BASE_VERSION" ]; then
              echo "âš  Warning: Could not determine base version, skipping version comparison"
            elif [ "$CURRENT_VERSION" = "$BASE_VERSION" ]; then
              echo "âŒ ERROR: Chart.yaml was modified but version did not change"
              echo "Current version: ${CURRENT_VERSION}"
              echo "Base version: ${BASE_VERSION}"
              exit 1
            else
              echo "âœ“ Chart version bumped: ${BASE_VERSION} -> ${CURRENT_VERSION}"
            fi
          else
            echo "âœ“ No template/values changes detected, version check skipped"
          fi

      - name: Update Helm dependencies
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm dependency build

      - name: Lint Helm chart
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm lint --strict .

      - name: Validate with kubeconform
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm template . | kubeconform \
            -strict \
            -summary \
            -schema-location default \
            -schema-location "https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json"

      - name: Run helm unittest
        working-directory: ${{ inputs.chart_path }}
        run: |
          helm unittest .

      # ðŸ”’ SECURITY: Validate golden file with Checkov 
      - name: Policy checks on golden file with Checkov
        uses: bridgecrewio/checkov-action@99bb2caf247dfd9f03cf984373bc6043d4e32ebf # v12.1347.0
        with:
          file: ${{ inputs.working_directory }}/gold_file.yaml
          framework: kubernetes
          soft_fail: false
          output_format: cli
          quiet: false
          skip_check: CKV_K8S_40

      # ðŸ”’ SECURITY: Pin Checkov action to commit SHA
      - name: Policy checks with Checkov
        uses: bridgecrewio/checkov-action@99bb2caf247dfd9f03cf984373bc6043d4e32ebf # v12.1347.0
        with:
          directory: ${{ inputs.chart_path }}
          framework: helm
          download_external_modules: true
          soft_fail: false
          output_format: cli
          quiet: false
          skip_check: CKV_K8S_40

      - name: Validate gold file
        working-directory: ${{ inputs.working_directory }}
        run: |
          chmod +x ./${{ inputs.script_name }}
          ./${{ inputs.script_name }} test
