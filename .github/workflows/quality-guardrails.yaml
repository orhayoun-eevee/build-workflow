name: Quality Guardrails

on:
  workflow_call:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'docker/Dockerfile'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'docker/Dockerfile'

permissions:
  contents: read

concurrency:
  group: quality-guardrails-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-automation:
    runs-on: ubuntu-latest
    env:
      SHFMT_VERSION: v3.11.0
      SHFMT_SHA256: 1904ec6bac715c1d05cd7f6612eec8f67a625c3749cb327e5bfb4127d09035ff
      ACTIONLINT_VERSION: v1.7.8
      ACTIONLINT_SHA256: be92c2652ab7b6d08425428797ceabeb16e31a781c07bc388456b4e592f3e36a
      HADOLINT_VERSION: v2.12.0
      HADOLINT_SHA256: 56de6d5e5ec427e17b74fa48d51271c7fc0d61244bf5c90e828aab8362d55010
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install shell and workflow linters
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

          curl -fsSL -o shfmt "https://github.com/mvdan/sh/releases/download/${SHFMT_VERSION}/shfmt_${SHFMT_VERSION}_linux_amd64"
          echo "${SHFMT_SHA256}  shfmt" | sha256sum -c -
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/shfmt
          shfmt --version

          curl -fsSL "https://github.com/rhysd/actionlint/releases/download/${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION#v}_linux_amd64.tar.gz" -o actionlint.tar.gz
          echo "${ACTIONLINT_SHA256}  actionlint.tar.gz" | sha256sum -c -
          tar -xzf actionlint.tar.gz actionlint
          chmod +x actionlint
          sudo mv actionlint /usr/local/bin/actionlint

          curl -fsSL -o hadolint "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64"
          echo "${HADOLINT_SHA256}  hadolint" | sha256sum -c -
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/hadolint

      - name: Run shellcheck
        run: |
          mkdir -p reports
          mapfile -t script_files < <(find scripts -type f -name '*.sh')
          if [ "${#script_files[@]}" -eq 0 ]; then
            echo "No shell scripts found"
            echo "No shell scripts found" > reports/shellcheck.txt
            exit 0
          fi
          shellcheck "${script_files[@]}" | tee reports/shellcheck.txt

      - name: Run shfmt (check mode)
        run: shfmt -d scripts | tee reports/shfmt.txt

      - name: Run actionlint
        run: actionlint | tee reports/actionlint.txt

      - name: Run hadolint
        run: hadolint --failure-threshold error docker/Dockerfile | tee reports/hadolint.txt

      - name: Disallow mutable or caller-controlled helm-validate refs
        run: |
          set -euo pipefail
          mkdir -p reports
          offending_files=$(grep -R -l "ghcr.io/orhayoun-eevee/helm-validate:latest" .github/workflows templates || true)
          offending_files=$(echo "${offending_files}" | grep -Ev "quality-guardrails\\.yaml" || true)
          if [[ -n "${offending_files}" ]]; then
            echo "Found mutable helm-validate image tags (:latest) in consumer workflows:"
            echo "${offending_files}"
            {
              echo "Found mutable helm-validate image tags (:latest) in consumer workflows:"
              echo "${offending_files}"
            } > reports/guardrails.txt
            exit 1
          fi

          override_files=$(grep -R -l -E '^[[:space:]]*(docker_image|build_workflow_ref):' .github/workflows templates || true)
          override_files=$(echo "${override_files}" | grep -Ev "quality-guardrails\\.yaml" || true)
          if [[ -n "${override_files}" ]]; then
            echo "Found disallowed caller override inputs (docker_image/build_workflow_ref):"
            echo "${override_files}"
            {
              echo "Found disallowed caller override inputs (docker_image/build_workflow_ref):"
              echo "${override_files}"
            } > reports/guardrails.txt
            exit 1
          fi

          mutable_workflow_refs=$(grep -R -l -E 'uses:\s*orhayoun-eevee/build-workflow/.+@main' templates .github/workflows || true)
          mutable_workflow_refs=$(echo "${mutable_workflow_refs}" | grep -Ev "quality-guardrails\\.yaml" || true)
          if [[ -n "${mutable_workflow_refs}" ]]; then
            echo "Found mutable build-workflow references (@main):"
            echo "${mutable_workflow_refs}"
            {
              echo "Found mutable build-workflow references (@main):"
              echo "${mutable_workflow_refs}"
            } > reports/guardrails.txt
            exit 1
          fi

          invalid_version_refs=$(grep -R -n -E 'uses:\s*orhayoun-eevee/build-workflow/.github/workflows/[^@\s]+@[^[:space:]]+' templates .github/workflows || true)
          invalid_version_refs=$(echo "${invalid_version_refs}" | grep -Ev '@v[0-9]+\.[0-9]+\.[0-9]+|@__BUILD_WORKFLOW_REF__' || true)
          invalid_version_refs=$(echo "${invalid_version_refs}" | grep -Ev 'quality-guardrails\\.yaml' || true)
          if [[ -n "${invalid_version_refs}" ]]; then
            echo "Found invalid build-workflow references (expected @vX.Y.Z):"
            echo "${invalid_version_refs}"
            {
              echo "Found invalid build-workflow references (expected @vX.Y.Z):"
              echo "${invalid_version_refs}"
            } > reports/guardrails.txt
            exit 1
          fi
          echo "Guardrail checks passed." > reports/guardrails.txt

      - name: Ensure Dockerfile download checksums are enforced
        run: |
          set -euo pipefail
          mkdir -p reports
          required_vars=(
            HELM_SHA256
            KUBECONFORM_SHA256
            CT_SHA256
            YQ_SHA256
            KUBE_LINTER_SHA256
          )

          for var in "${required_vars[@]}"; do
            if ! grep -q "^ENV ${var}=" docker/Dockerfile; then
              echo "Missing checksum variable in docker/Dockerfile: ${var}"
              exit 1
            fi
          done

          if [[ "$(grep -c 'sha256sum -c -' docker/Dockerfile)" -lt 5 ]]; then
            echo "Expected checksum verification for all downloaded binaries."
            exit 1
          fi
          echo "Dockerfile checksum enforcement checks passed." > reports/dockerfile-checksums.txt

      - name: Ensure renovate coverage for workflow and image refs
        run: |
          set -euo pipefail
          mkdir -p reports
          dep_types=$(jq -r '.customManagers[]?.depTypeTemplate // empty' renovate.json | sort -u)
          required_dep_types=(workflow-version workflow-image tool-version python-package)

          for dep_type in "${required_dep_types[@]}"; do
            if ! grep -qx "${dep_type}" <<<"${dep_types}"; then
              echo "Missing renovate custom manager depTypeTemplate: ${dep_type}"
              exit 1
            fi
          done

          if ! jq -e '.customManagers[]? | select(.managerFilePatterns[]? | test("\\.github/workflows"))' renovate.json >/dev/null; then
            echo "Missing custom manager coverage for workflow files."
            exit 1
          fi

          echo "Renovate coverage checks passed." > reports/renovate-coverage.txt

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: quality-guardrails-reports
          path: reports/
          retention-days: 7
